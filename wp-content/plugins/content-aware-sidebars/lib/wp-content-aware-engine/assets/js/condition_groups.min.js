/*!
 * @package WP Content Aware Engine
 * @version 2.0
 * @copyright Joachim Jensen <jv@intox.dk>
 * @license GPLv3
 */
!function(a){"use strict";a.fn.select2.locales.en={formatNoMatches:function(){return WPCA.noResults},formatSearching:function(){return WPCA.searching+"..."}},a.extend(a.fn.select2.defaults,a.fn.select2.locales.en);var b=b||{};b.Models={Alert:Backbone.Model.extend({defaults:{text:"",cssClass:"updated"},sync:function(){return!1},url:"",reset:function(){this.set(this.defaults)}}),Condition:Backbone.Model.extend({defaults:{module:null,label:null,values:null,options:{}},sync:function(){return!1},url:""}),Group:Backbone.Model.extend({defaults:{id:null,status:null,options:{},conditions:null},initialize:function(){this.conditions||(this.conditions=new b.Models.ConditionCollection)},parse:function(a){if(_.has(a,"conditions")){var c=[];for(var d in a.conditions)if(a.conditions.hasOwnProperty(d)){var e=[];for(var f in a.conditions[d].data)a.conditions[d].data.hasOwnProperty(f)&&e.push({text:a.conditions[d].data[f],id:f});c.push({label:a.conditions[d].label,module:d,values:e,options:a.conditions[d].options||{}})}this.conditions=new b.Models.ConditionCollection(c),delete a.conditions}return a},sync:function(){return!1},url:""}),GroupCollection:Backbone.Collection.extend({model:function(a,c){return new b.Models.Group(a,c)},parse:function(a){return a}}),ConditionCollection:Backbone.Collection.extend({model:function(a,c){return new b.Models.Condition(a,c)}})},b.Views={Alert:Backbone.View.extend({tagName:"div",className:"wpca-alert",template:_.template('<div class="<%= cssClass %>"><%= text %></div>'),timer:4e3,success:function(a){this.model.set({text:a,cssClass:"wpca-success"})},failure:function(a){this.model.set({text:a,cssClass:"wpca-error"})},dismiss:function(){this.model.reset()},initialize:function(){this.listenTo(this.model,"change",this.render),this.$el.appendTo("body")},render:function(){if(""!==this.model.get("text")){var a=this;this.$el.hide().html(this.template(this.model.attributes)).fadeIn("slow"),setTimeout(function(){a.$el.fadeOut("slow"),a.dismiss()},this.timer)}else this.$el.fadeOut("slow")}}),Condition:Backbone.View.extend({tagName:"div",className:"cas-condition",events:{"click .js-wpca-condition-remove":"removeCondition"},initialize:function(){this.listenTo(this.model,"destroy",this.remove),this.template=_.template(a("#wpca-template-"+this.model.get("module")).html()),this.render()},render:function(){this.$el.append(this.template(this.model.attributes));var a=this.$el.find(".js-wpca-suggest");a.length&&c.createSuggestInput(a,this.model.get("module"),this.model.get("values"))},removeCondition:function(a){this.model.destroy()}}),Group:Backbone.View.extend({tagName:"li",className:"cas-group-single",template:_.template(a("#wpca-template-group").html()),events:{"change .js-wpca-add-and":"addConditionModel","click .js-wpca-save-group":"saveGroup"},initialize:function(){this.render(),this.listenTo(this.model,"destroy",this.fadeRemove),this.listenTo(this.model.conditions,"remove",this.removeCondition),this.listenTo(this.model.conditions,"add",this.addConditionView)},render:function(){this.$el.append(this.template(this.model.attributes)),this.model.conditions.each(this.addConditionView,this)},addConditionModel:function(c){var d=a(c.currentTarget);if(!this.model.conditions.findWhere({module:d.val()})){var e=new b.Models.Condition({module:d.val(),label:d.children(":selected").text()});this.model.conditions.add(e)}d.val(0).blur()},addConditionView:function(a){var c=new b.Views.Condition({model:a});c.$el.hide().appendTo(this.$el.find(".cas-content")).fadeIn()},removeCondition:function(a){this.model.conditions.length||(this.model.get("id")?this.saveGroup():this.model.destroy())},saveGroup:function(b){var d={action:"wpca/add-rule",token:c.nonce,current_id:c.sidebarID},e=this;this.model.get("id")&&(d.cas_group_id=this.model.get("id")),this.$el.find("input").each(function(b,c){var e=a(c),f=e.attr("name");if(f&&("checkbox"!=e.attr("type")||e.is(":checked"))){var g=e.val();~f.indexOf("cas_condition")&&(!g&&e.data("wpca-default")&&(g=e.data("wpca-default")),g=g?g.split(","):[],d[f]&&(g=g.concat(d[f]))),g&&(d[f]=g)}}),a.ajax({url:ajaxurl,data:d,dataType:"JSON",type:"POST",success:function(a){c.alert.success(a.message),a.removed?e.model.destroy():a.new_post_id&&e.model.set("id",a.new_post_id)},error:function(a,b,d){c.alert.failure(a.responseText)}})},fadeRemove:function(){this.$el.fadeOut(600,function(){this.remove()})}}),GroupCollection:Backbone.View.extend({el:"#cas-groups",events:{"change .js-wpca-add-or":"addGroupModel"},initialize:function(){this.render(),this.listenTo(this.collection,"add",this.addGroupView)},render:function(){this.collection.each(this.addGroupView,this),a(".js-wpca-add-or").focus()},addGroupModel:function(c){var d=a(c.currentTarget),e=new b.Models.Group,f=new b.Models.Condition({module:d.val(),label:d.children(":selected").text()});e.conditions.add(f),this.collection.add(e),d.val(0).blur()},addGroupView:function(a){var c=new b.Views.Group({model:a});c.$el.hide().appendTo(this.$el.children("ul").first()).fadeIn(600)}})};var c={nonce:a("#_ca_nonce").val(),sidebarID:a("#current_sidebar").val(),alert:null,init:function(){this.alert=new b.Views.Alert({model:new b.Models.Alert}),new b.Views.GroupCollection({collection:new b.Models.GroupCollection(WPCA.groups,{parse:!0})})},createSuggestInput:function(b,d,e){b.select2({cacheDataSource:[],quietMillis:400,searchTimer:null,placeholder:b.data("wpca-placeholder"),minimumInputLength:0,closeOnSelect:!0,allowClear:!0,multiple:!0,width:"100%",nextSearchTerm:function(a,b){return b},query:function(b){var e=this,f=e.cacheDataSource[b.term];return f?void b.callback({results:f}):(clearTimeout(e.searchTimer),void(e.searchTimer=setTimeout(function(){a.ajax({url:ajaxurl,data:{search:b.term,action:"wpca/module/"+d,sidebar_id:c.sidebarID,nonce:c.nonce},dataType:"JSON",type:"POST",success:function(a){var c=[];for(var d in a)a.hasOwnProperty(d)&&c.push({id:d,text:a[d]});e.cacheDataSource[b.term]=c,b.callback({results:c})}})},e.quietMillis)))}}).on("select2-selecting",function(a){b.data("forceOpen",!0)}).on("select2-close",function(a){b.data("forceOpen")&&(a.preventDefault(),b.select2("open"),b.data("forceOpen",!1))}),e&&b.select2("data",e)}};a(document).ready(function(){c.init()})}(jQuery);